# =====================================================
# Test: Shared complex types work across plugins
# =====================================================
print Test: Shared complex types — two plugins sharing AppConfig, SharedState, UpperProcessor

load writer plugins/shared-good-plugin
load reader plugins/shared-reader-plugin

assert_resource app-config
assert_resource shared-state
assert_resource processor

# Writer uses its own resources
send writer first-request

# Reader reads resources created by writer — cross-plugin sharing of complex types
send reader reader-check

# Writer sends again — should see reader's mutations in shared-state
send writer second-request

# =====================================================
# Test: Reload reader, writer stays — shared state survives
# =====================================================
print Test: Reload reader, shared state survives

unload reader
assert_resource app-config
assert_resource shared-state

load reader2 plugins/shared-reader-plugin
send reader2 after-reader-reload

# =====================================================
# Test: Reload writer — resources cleaned up, reader sees nothing
# =====================================================
print Test: Reload writer, resources cleaned up

unload writer
assert_no_resource app-config
assert_no_resource shared-state
assert_no_resource processor

# Reader should handle missing resources gracefully
send reader2 after-writer-unload

# Reload writer — fresh resources
load writer2 plugins/shared-good-plugin
assert_resource app-config
assert_resource shared-state

# Reader can see fresh resources
send reader2 after-writer-reload

# Cleanup
unload writer2
unload reader2
assert_no_resource app-config
assert_no_resource shared-state

# =====================================================
# Test: Arc<dyn Trait> — works while both loaded
# =====================================================
print Test: Arc<dyn Trait> works while originating plugin loaded

load arcdyn plugins/bad-arcdyn-plugin
send arcdyn test-arcdyn
assert_resource dyn-processor
unload arcdyn
assert_no_resource dyn-processor

print All safety tests complete
